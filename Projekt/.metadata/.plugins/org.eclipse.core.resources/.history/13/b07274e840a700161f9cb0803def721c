import java.io.BufferedReader;
import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.io.InputStreamReader;

import javax.bluetooth.DiscoveryAgent;
import javax.bluetooth.LocalDevice;
import javax.microedition.io.Connector;
import javax.microedition.io.StreamConnectionNotifier;

public class ClientCommunication implements Runnable{

	@Override
	public void run() {
		try {
			System.out.println("Setting device to be discoverable...");
			local = LocalDevice.getLocalDevice();
			local.setDiscoverable(DiscoveryAgent.GIAC);
			System.out.println("Start advertising service...");
			server = (StreamConnectionNotifier) Connector.open(url);
			System.out.println("Waiting for incoming connection...");
			conn = server.acceptAndOpen();
			System.out.println("Client Connected...");
			DataInputStream din = new DataInputStream(conn.openInputStream());
			DataOutputStream out = new DataOutputStream(conn.openOutputStream());
			System.out.println("got input");
			boolean firstMessage = true;
			while (true) {
				BufferedReader br = new BufferedReader(new InputStreamReader(din));
				String lineRead = br.readLine();
				if (lineRead != null)
					if(!firstMessage){
						respondToClient(out,lineRead);
					}
				if (firstMessage) {
					out.write(("1;TelefonDienst"+"\n").getBytes());
					firstMessage = false;
				}
			}
		} catch (Exception e) {
			System.out.println("Exception Occured: " + e.toString());
		}
	}

}
